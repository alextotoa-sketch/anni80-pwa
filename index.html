<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Io negli anni â€™80 câ€™ero</title>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif}
body{background:#0b0b0b;color:#fff;min-height:100vh;display:flex;flex-direction:column}

/* HEADER */
header{padding:16px;text-align:center;border-bottom:2px solid #00e5ff}
header h1{color:#00e5ff}
header p{color:#aaa}

/* MAIN */
main{flex:1;padding:12px;padding-bottom:120px}

/* SEZIONI */
.categories{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin-bottom:12px;
}
.category{
  border:2px solid #00e5ff;
  border-radius:12px;
  padding:12px;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
}
.category.active{background:#00e5ff;color:#000}
@media(max-width:900px){
  .categories{grid-template-columns:1fr 1fr}
}

/* V-METER */
#vmeterBox{
  margin-bottom:12px;
  padding:12px;
  border:2px solid #00e5ff;
  border-radius:12px;
  background:#000;
}
#vmeter{
  display:flex;
  gap:14px;
  height:70px;
}
.vbar{
  flex:1;
  background:#111;
  border-radius:8px;
  overflow:hidden;
}
.vfill{
  height:0%;
  width:100%;
  background:linear-gradient(to top,#00ff66,#ccffcc);
  box-shadow:0 0 12px #00ff66;
  transition:height 0.05s linear;
}

/* CONTENT */
#content{
  border:2px solid #00e5ff;
  border-radius:12px;
  padding:14px;
  min-height:220px;
}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.card{
  border:2px solid #00e5ff;
  border-radius:12px;
  padding:12px;
  background:#1b1b1b;
  text-align:center;
  cursor:pointer;
}
.card:hover{background:#00e5ff;color:#000}
a.card{color:inherit;text-decoration:none}

/* PLAYER */
#player{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#1b1b1b;
  border-top:2px solid #00e5ff;
  padding:10px;
  text-align:center;
}
#now{color:#00e5ff;font-weight:bold;margin-bottom:6px}
audio{width:95%}

/* CHAT */
#chatToggle{
  position:fixed;
  right:14px;
  bottom:140px;
  width:56px;
  height:56px;
  border-radius:50%;
  background:#00e5ff;
  border:none;
  font-size:26px;
}
#chat{
  position:fixed;
  inset:0;
  background:#0b0b0b;
  display:none;
  flex-direction:column;
  z-index:2000;
}
#chatHeader{
  padding:14px;
  background:#1b1b1b;
  border-bottom:2px solid #00e5ff;
  display:flex;
  justify-content:space-between;
}
#chatMessages{flex:1;overflow-y:auto;padding:14px}
#chatForm{display:flex;border-top:2px solid #00e5ff}
#chatInput{
  flex:1;
  padding:14px;
  background:#222;
  color:#fff;
  border:none;
  font-size:16px;
}
#chatForm button{
  padding:14px;
  background:#00e5ff;
  border:none;
  font-weight:bold;
}
</style>
</head>

<body>

<header>
  <h1>Io negli anni â€™80 câ€™ero</h1>
  <p>Radio Â· Musica Â· Giochi Â· Chat</p>
</header>

<main>
  <div class="categories" id="categories"></div>

  <div id="vmeterBox">
    <div id="vmeter">
      <div class="vbar"><div class="vfill" id="vL"></div></div>
      <div class="vbar"><div class="vfill" id="vR"></div></div>
    </div>
  </div>

  <div id="content">Seleziona una sezione.</div>
</main>

<div id="player">
  <div id="now">Nessuna radio attiva</div>
  <audio id="audio" controls playsinline></audio>
</div>

<button id="chatToggle">ðŸ’¬</button>

<div id="chat">
  <div id="chatHeader">
    <strong>Chat anni â€™80</strong>
    <button onclick="chat.style.display='none'"
      style="background:none;border:none;color:#00e5ff;font-size:22px">âœ•</button>
  </div>
  <div id="chatMessages"></div>
  <form id="chatForm">
    <input id="chatInput" placeholder="Scriviâ€¦" autocomplete="off">
    <button>Invia</button>
  </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyB8h3fvyPxq_Tjp2R5RzsgEC7jv6FASeWE",
  authDomain:"anni-80-chat-a1192.firebaseapp.com",
  databaseURL:"https://anni-80-chat-a1192-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"anni-80-chat-a1192"
});
const db = getDatabase(app);
const chatRef = ref(db,"chat");

/* NICK */
let nickname = localStorage.getItem("anni80_nick");
if(!nickname){
  nickname = prompt("Scegli il tuo nickname anni â€™80:") || "Anonimo80";
  localStorage.setItem("anni80_nick", nickname);
}

/* CHAT */
chatToggle.onclick=()=>chat.style.display="flex";
chatForm.addEventListener("submit",e=>{
  e.preventDefault();
  if(chatInput.value.trim()){
    push(chatRef,{nick:nickname,text:chatInput.value});
    chatInput.value="";
  }
});
onChildAdded(chatRef,s=>{
  const m=s.val();
  const d=document.createElement("div");
  d.innerHTML=`<strong>[${m.nick}]</strong>: ${m.text}`;
  chatMessages.appendChild(d);
  chatMessages.scrollTop=chatMessages.scrollHeight;
});

/* SEZIONI */
const radios=[
  {n:"Radio 80",u:"https://sphera.fluidstream.eu/radio80.aac"},
  {n:"SomaFM Underground 80s",u:"https://somafm.com/u80s130.mp3"},
  {n:"80s80s Italo Disco",u:"https://streams.80s80s.de/italodisco/mp3-192"},
  {n:"Italia 80",u:"https://stream.laut.fm/italia80"}
];

["Musica","Radio","Giochi","Chat"].forEach((c,i)=>{
  const d=document.createElement("div");
  d.className="category";
  d.textContent=c;
  d.onclick=()=>open(i,d);
  categories.appendChild(d);
});

function open(i,el){
  document.querySelectorAll(".category").forEach(x=>x.classList.remove("active"));
  el.classList.add("active");

  if(i===0){
    content.innerHTML=`<div class="grid">
      <a class="card" href="https://www.youtube.com/results?search_query=italo+disco+80s" target="_blank">Italo Disco</a>
      <a class="card" href="https://www.youtube.com/results?search_query=synth+pop+80s" target="_blank">Synth Pop</a>
    </div>`;
  }
  if(i===1){
    content.innerHTML=`<div class="grid">${
      radios.map(r=>`<div class="card" onclick="playRadio('${r.u}','${r.n}')">${r.n}</div>`).join("")
    }</div>`;
  }
  if(i===2){
    content.innerHTML=`<div class="grid">
      <a class="card" href="https://archive.org/details/msdos_Pac-Man_1983" target="_blank">Pac-Man</a>
      <a class="card" href="https://archive.org/details/msdos_Oregon_Trail_1990" target="_blank">Oregon Trail</a>
    </div>`;
  }
  if(i===3){chat.style.display="flex";}
}

/* V-METER CORRETTO */
const audio=document.getElementById("audio");
const now=document.getElementById("now");
const vL=document.getElementById("vL");
const vR=document.getElementById("vR");

let ctx, analyser, src, data;

function meterLoop(){
  analyser.getByteTimeDomainData(data);
  let sum=0;
  for(let i=0;i<data.length;i++){
    let v=(data[i]-128)/128;
    sum+=v*v;
  }
  let level=Math.min(100,Math.sqrt(sum/data.length)*160);
  vL.style.height=level+"%";
  vR.style.height=(level*0.9)+"%";
  requestAnimationFrame(meterLoop);
}

window.playRadio=(u,n)=>{
  audio.src=u;
  audio.play();
  now.textContent="In riproduzione: "+n;

  if(!ctx){
    ctx=new (window.AudioContext||window.webkitAudioContext)();
    src=ctx.createMediaElementSource(audio);
    analyser=ctx.createAnalyser();
    analyser.fftSize=256;
    data=new Uint8Array(analyser.fftSize);
    src.connect(analyser);
    analyser.connect(ctx.destination);
    meterLoop();
  }
  ctx.resume();
};
</script>

</body>
</html>
